import json
import os

import requests

import config


def get_vulnerability_alerts():
    headers = {"Authorization": f"Bearer {os.getenv('GITHUB_TOKEN')}"}

    response = requests.post(config.QUERY_URL, json={'query': config.VULNERABILITY_ALERTS_QUERY}, headers=headers)
    if response.status_code == 200:
        alerts = extracts_alerts(response)

        print("Vulnerability alerts:")
        for alert in alerts:
            prints_vulnerability_alert(alert)
    else:
        print(f"Query failed to run by returning code of {response.status_code}\n")


def extracts_alerts(response):
    result = response.json()
    alerts = result["data"]["repository"]["vulnerabilityAlerts"]["edges"]
    return alerts


def prints_vulnerability_alert(alert):
    print(json.dumps(alert["node"], indent=4))
    print()
